<view class="container">
  <!-- Top Search Bar -->
  <view class="header">
    <view class="search-bar">
      <picker mode="selector" range="{{cities}}" bindchange="onCityChange">
        <view class="city-selector">
          <text>{{query.city || '全部城市'}}</text>
          <view class="arrow-down"></view>
        </view>
      </picker>

      <view class="date-selector">
        <picker mode="date" value="{{query.checkIn}}" bindchange="onCheckInChange">
          <view class="date-info">
            <text class="date-label">住 {{query.checkInShort}}</text>
          </view>
        </picker>
        <picker mode="date" value="{{query.checkOut}}" bindchange="onCheckOutChange">
          <view class="date-info">
            <text class="date-label">离 {{query.checkOutShort}}</text>
          </view>
        </picker>
        <view class="night-count">{{nights}}晚</view>
      </view>

      <view class="keyword-input" bindtap="openSearch">
        <text class="placeholder">{{query.keyword || '关键字/位置/品牌'}}</text>
      </view>

      <!-- Inline search input overlay -->
      <view wx:if="{{showSearchInput}}" class="search-overlay">
        <input class="search-input" placeholder="输入关键字/位置/品牌" value="{{query.keyword}}" bindinput="onSearchInput" />
        <button class="search-btn" bindtap="onSearchConfirm">搜索</button>
      </view>
    </view>

    <!-- Filter Bar -->
    <view class="filter-bar">
      <view class="filter-item {{activeFilter === 'sort' ? 'active' : ''}}" data-type="sort" bindtap="onFilterTap">
        <text>{{currentSortLabel}}</text>
        <view class="arrow-down"></view>
      </view>
      <view class="filter-item {{activeFilter === 'score' ? 'active' : ''}}" data-type="score" bindtap="onFilterTap">
        <text>欢迎度排序</text>
      </view>
      <view class="filter-item {{activeFilter === 'priceStar' ? 'active' : ''}}" data-type="priceStar" bindtap="onFilterTap">
        <text>价格/星级</text>
        <view class="arrow-down"></view>
      </view>
      <view class="filter-item {{activeFilter === 'more' ? 'active' : ''}}" data-type="more" bindtap="onFilterTap">
        <text>筛选</text>
        <view class="filter-icon"></view>
      </view>
    </view>
  </view>

  <!-- Filter Popup (Price/Star) -->
  <view class="filter-popup" wx:if="{{activeFilter === 'priceStar'}}">
    <view class="popup-mask" bindtap="closeFilter"></view>
    <view class="popup-content">
      <view class="filter-section">
        <view class="section-title">价格范围 (¥)</view>
        <view class="price-options">
          <view wx:for="{{priceRanges}}" wx:key="label" 
            class="price-tag {{selectedPriceRange.label === item.label ? 'selected' : ''}}"
            data-index="{{index}}" bindtap="onPriceRangeSelect">
            {{item.label}}
          </view>
        </view>
      </view>
      <view class="filter-section">
        <view class="section-title">星级</view>
        <view class="star-options">
           <view wx:for="{{[3,4,5]}}" wx:key="*this"
            class="star-tag {{selectedStar == item ? 'selected' : ''}}"
            data-star="{{item}}" bindtap="onStarSelect">
            {{item}}星及以上
          </view>
        </view>
      </view>
      <view class="popup-footer">
        <button class="btn-reset" bindtap="resetFilter">重置</button>
        <button class="btn-confirm" bindtap="applyFilter">确定</button>
      </view>
    </view>
  </view>

  <!-- Filter Popup (More) -->
  <view class="filter-popup" wx:if="{{activeFilter === 'more'}}">
    <view class="popup-mask" bindtap="closeFilter"></view>
    <view class="popup-content">
      <view class="filter-section">
        <view class="section-title">更多筛选</view>
        <view class="facilities-options">
          <view wx:for="{{facilities}}" wx:key="*this" class="facility-tag {{selectedFacilities.indexOf(item) !== -1 ? 'selected' : ''}}" data-index="{{index}}" bindtap="toggleFacility">
            {{item}}
          </view>
        </view>
      </view>
      <view class="popup-footer">
        <button class="btn-reset" bindtap="resetFilter">重置</button>
        <button class="btn-confirm" bindtap="applyFilter">确定</button>
      </view>
    </view>
  </view>

    <!-- Filter Popup (Sort) -->
  <view class="filter-popup" wx:if="{{activeFilter === 'sort'}}">
    <view class="popup-mask" bindtap="closeFilter"></view>
    <view class="popup-content">
      <view class="sort-list">
        <view class="sort-item {{currentSort === 'default' ? 'active' : ''}}" data-sort="default" bindtap="onSortSelect">智能排序</view>
        <view class="sort-item {{currentSort === 'price_asc' ? 'active' : ''}}" data-sort="price_asc" bindtap="onSortSelect">价格低到高</view>
        <view class="sort-item {{currentSort === 'price_desc' ? 'active' : ''}}" data-sort="price_desc" bindtap="onSortSelect">价格高到低</view>
        <view class="sort-item {{currentSort === 'score_desc' ? 'active' : ''}}" data-sort="score_desc" bindtap="onSortSelect">评分高到低</view>
      </view>
    </view>
  </view>

  <!-- Hotel List -->
  <scroll-view scroll-y="true" class="hotel-list" bindscrolltolower="onReachBottom" lower-threshold="50">
    <view class="hotel-item" wx:for="{{items}}" wx:key="id" bindtap="onItemTap" data-id="{{item.id}}">
      <image class="hotel-image" src="{{item.images[0] || 'https://via.placeholder.com/200'}}" mode="aspectFill"></image>
      <view class="hotel-info">
        <view class="hotel-name">{{item.nameZh}}</view>
        <view class="hotel-score-row">
          <text class="score-badge">{{item.score}}分</text>
          <text class="comment-desc">"挺好的"</text> <!-- Placeholder if no comments -->
        </view>
        <view class="hotel-address">
            <text>{{item.city}} {{item.address}}</text>
        </view>
        <view class="hotel-tags">
           <text class="tag" wx:for="{{item.facilities}}" wx:key="*this" wx:if="{{index < 3}}">{{item}}</text>
        </view>
        <view class="hotel-bottom">
          <view class="price-box">
            <text class="currency">¥</text>
            <text class="price">{{item.minPrice}}</text>
            <text class="unit">起</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="loading-state" wx:if="{{loading}}">正在加载...</view>
    <view class="no-more" wx:if="{{!hasMore && !loading}}">没有更多了</view>
    <view class="error-state" wx:if="{{error}}" bindtap="loadMore">{{error}} 点击重试</view>
  </scroll-view>
</view>
