<view class="page">
  <view class="content">
    <!-- Banner -->
    <view class="banner">
      <swiper class="banner-swiper" autoplay="false" circular="true" indicator-dots="true" indicator-color="rgba(255,255,255,0.5)" indicator-active-color="#ffffff">
        <block wx:if="{{bannerMedias.length > 0}}">
          <swiper-item wx:for="{{bannerMedias}}" wx:key="url">
            <block wx:if="{{item.type === 'video'}}">
              <video class="banner-video" src="{{item.url}}" objectFit="cover" controls="true" muted="{{true}}" show-mute-btn="true" show-fullscreen-btn="true" show-center-play-btn="true" autoplay="false" loop="false" enable-play-gesture="true" vslide-gesture="true" vslide-gesture-in-fullscreen="true" bindtap="onPreviewMedia" data-index="{{index}}" />
            </block>
            <block wx:else>
              <image class="banner-img" mode="aspectFill" src="{{item.url}}" bindtap="onPreviewMedia" data-index="{{index}}" />
            </block>
          </swiper-item>
        </block>
        <block wx:else>
          <swiper-item>
            <view class="banner-placeholder">
              <view class="banner-ph-title">YISU HOTEL</view>
              <view class="banner-ph-sub">Premium Stay Experience</view>
            </view>
          </swiper-item>
        </block>
      </swiper>
    </view>

    <!-- Base Info -->
    <view class="card">
      <view class="title-row">
        <view class="hotel-name">{{hotel.nameZh || hotel.nameEn || '-'}}</view>
        <view class="star">{{hotel.star || '-' }} 星</view>
      </view>
      <view class="sub-row">{{hotel.nameEn || ''}}</view>

      <view class="kv">
        <view class="kv-label">地址</view>
        <view class="kv-value">
          <view class="addr-text">{{hotel.address || '-'}}</view>
          <view class="near-row" wx:if="{{lng && lat}}">
            <view class="near-left">
              <view wx:if="{{nearbySubwayTop.length > 0}}" class="near-item">
                最近地铁：{{nearbySubwayTop[0].name}} · {{nearbySubwayTop[0].distanceText}}
              </view>
              <view wx:elif="{{poisLoading}}" class="near-item">附近信息加载中...</view>
              <view wx:elif="{{poisError}}" class="near-item">{{poisError}}</view>
              <view wx:else class="near-item">暂无周边信息</view>
            </view>
            <view class="near-btn" bindtap="onOpenPoiPanel">周边</view>
          </view>
        </view>
      </view>

      <view class="kv" wx:if="{{lng && lat}}">
        <view class="kv-label">位置</view>
        <view class="kv-value">
          <view class="loc-row">
            <view class="loc-text">{{lng}}, {{lat}}</view>
            <view class="loc-btn" bindtap="onOpenLocation">导航</view>
          </view>
        </view>
      </view>

      <view class="kv">
        <view class="kv-label">设施</view>
        <view class="kv-value">
          <view class="tags" wx:if="{{facilities.length > 0}}">
            <view class="tag" wx:for="{{facilities}}" wx:key="*this">{{item}}</view>
          </view>
          <view class="muted" wx:else>暂无设施信息</view>
        </view>
      </view>
    </view>

    <view class="poi-mask" wx:if="{{poiPanelOpen}}" bindtap="onClosePoiPanel"></view>
    <view class="poi-panel" wx:if="{{poiPanelOpen}}">
      <view class="poi-panel-head">
        <view class="poi-panel-title">周边信息</view>
        <view class="poi-panel-close" bindtap="onClosePoiPanel">关闭</view>
      </view>

      <view class="poi-panel-body">
        <view class="poi-head">
          <view class="section-title">详情</view>
          <view class="poi-toggle" bindtap="onTogglePois">{{poisExpanded ? '收起' : '展开更多'}}</view>
        </view>
        <view class="section-sub" wx:if="{{poisLoading}}">加载中...</view>
        <view class="section-sub" wx:elif="{{poisError}}">{{poisError}}</view>

        <map
          class="hotel-map"
          longitude="{{lng}}"
          latitude="{{lat}}"
          markers="{{markers}}"
          scale="15"
          show-location="true"
        />

        <view class="poi-group">
          <view class="poi-title">附近地铁</view>
          <view wx:if="{{nearbySubwayView.length === 0}}" class="poi-empty">暂无</view>
          <view wx:for="{{nearbySubwayView}}" wx:key="id" class="poi-item" bindtap="onOpenPoiLocation" data-lng="{{item.lng}}" data-lat="{{item.lat}}" data-name="{{item.name}}" data-address="{{item.address}}">
            <view class="poi-left">
              <view class="poi-name">{{item.name}}</view>
              <view class="poi-addr">{{item.address}}</view>
            </view>
            <view class="poi-dist">{{item.distanceText}}</view>
          </view>
        </view>

        <view class="poi-group">
          <view class="poi-title">附近公交</view>
          <view wx:if="{{nearbyBusView.length === 0}}" class="poi-empty">暂无</view>
          <view wx:for="{{nearbyBusView}}" wx:key="id" class="poi-item" bindtap="onOpenPoiLocation" data-lng="{{item.lng}}" data-lat="{{item.lat}}" data-name="{{item.name}}" data-address="{{item.address}}">
            <view class="poi-left">
              <view class="poi-name">{{item.name}}</view>
              <view class="poi-addr">{{item.address}}</view>
            </view>
            <view class="poi-dist">{{item.distanceText}}</view>
          </view>
        </view>

        <view class="poi-group">
          <view class="poi-title">附近餐饮</view>
          <view wx:if="{{nearbyFoodView.length === 0}}" class="poi-empty">暂无</view>
          <view wx:for="{{nearbyFoodView}}" wx:key="id" class="poi-item" bindtap="onOpenPoiLocation" data-lng="{{item.lng}}" data-lat="{{item.lat}}" data-name="{{item.name}}" data-address="{{item.address}}">
            <view class="poi-left">
              <view class="poi-name">{{item.name}}</view>
              <view class="poi-addr">{{item.address}}</view>
            </view>
            <view class="poi-dist">{{item.distanceText}}</view>
          </view>
        </view>
        <view class="poi-panel-space"></view>
      </view>
    </view>

    <!-- Calendar + Guests + Nights Banner -->
    <view class="card banner2">
      <view class="banner2-title">入住信息</view>
      <view class="banner2-row">
        <view class="date-block">
          <view class="date-label">入住</view>
          <picker mode="date" value="{{checkIn}}" start="{{today}}" bindchange="onCheckInChange">
            <view class="date-value">{{checkIn}}</view>
          </picker>
        </view>

        <view class="mid">
          <view class="nights">{{nights}} 晚</view>
          <view class="line"></view>
        </view>

        <view class="date-block">
          <view class="date-label">离店</view>
          <picker mode="date" value="{{checkOut}}" start="{{today}}" bindchange="onCheckOutChange">
            <view class="date-value">{{checkOut}}</view>
          </picker>
        </view>
      </view>

      <view class="banner2-row2">
        <view class="counter">
          <view class="counter-label">人数</view>
          <view class="counter-ctl">
            <view class="btn" bindtap="decGuests">-</view>
            <view class="num">{{guests}}</view>
            <view class="btn" bindtap="incGuests">+</view>
          </view>
        </view>
        <view class="counter">
          <view class="counter-label">房间</view>
          <view class="counter-ctl">
            <view class="btn" bindtap="decRooms">-</view>
            <view class="num">{{roomCount}}</view>
            <view class="btn" bindtap="incRooms">+</view>
          </view>
        </view>
      </view>
    </view>

    <!-- Rooms -->
    <view class="card">
      <view class="section-title">房型价格</view>
      <view class="section-sub">价格从低到高（按商户录入）</view>

      <view class="room" wx:for="{{rooms}}" wx:key="id" bindtap="onSelectRoom" data-index="{{index}}">
        <view class="room-left">
          <view class="room-name">{{item.name}}</view>
          <view class="room-sub">
            <text wx:if="{{item.bedType}}">{{item.bedType}}</text>
            <text wx:if="{{item.bedType && (item.area || item.breakfast)}}"> · </text>
            <text wx:if="{{item.area}}">{{item.area}}㎡</text>
            <text wx:if="{{item.area && item.breakfast}}"> · </text>
            <text wx:if="{{item.breakfast}}">{{item.breakfast}}</text>
            <text wx:if="{{!item.bedType && !item.area && !item.breakfast}}">可订 · 含税/服务费规则以实际为准</text>
          </view>
        </view>
        <view class="room-right">
          <view class="price">
            <text class="yen">¥</text>
            <text class="p">{{item.price}}</text>
          </view>
          <view class="per">每晚</view>
          <view class="room-book">立即预订</view>
        </view>
      </view>

      <view wx:if="{{rooms.length === 0}}" class="empty">暂无房型</view>
    </view>

    <view wx:if="{{error}}" class="error">{{error}}</view>
    <view class="footer-space"></view>
  </view>

  <assistant-float iconSrc="/components/assets/ai.png" />
</view>
